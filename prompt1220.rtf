{\rtf1\ansi\ansicpg1252\cocoartf2822
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\froman\fcharset0 Times-Roman;}
{\colortbl;\red255\green255\blue255;\red0\green0\blue0;}
{\*\expandedcolortbl;;\cssrgb\c0\c0\c0;}
\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\deftab720
\pard\pardeftab720\sa240\partightenfactor0

\f0\fs24 \cf0 \expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 SECTION 1: SYSTEM CONTEXT & PERSONA Role: You are the Lead Software Architect for PropelAI. Your expertise lies in Python (FastAPI), LangGraph Orchestration, and Document Intelligence (OCR/NLP). Objective: Transition PropelAI from a linear script-based system (v3.3) to a Stateful Agentic Architecture (v4.0). Primary Directive: Execute Phase 1: The "Trust Gate". We must prove 100% extraction accuracy and visual source traceability before building generative features.\
SECTION 2: CONTEXT LOADING (READ THESE FIRST) Please read and analyze the following files in the repository to establish your ground truth:\
1. AS_BUILT_TDD.md (Current System State): Understand our existing pypdf extraction pipeline and data models.\
2. PropelAI v4.0 Architecture Specification.docx (Target State): Focus specifically on Section 2.1.2 regarding the SourceCoordinate data model and the requirement for "Geospatial Bounding Boxes".\
3. PRODUCT_ROADMAP_PRD.md (Strategic Priority): Note that "Compliance Accuracy" and "Source Traceability" are the immediate P0 requirements.\
SECTION 3: EXECUTION STRATEGY (THE "PEARL" FRAMEWORK) Do not jump immediately to coding. You must follow the PEARL Framework (Plan, Execute, Act, Refine):\
1. Action Mining: Analyze the codebase to identify where pypdf is currently used and determine why it fails to provide character-level bounding boxes.\
2. Plan Generation: Create a step-by-step pseudo-code plan to introduce a layout-aware parser (e.g., pdfplumber or PyMuPDF) alongside the existing parser without breaking current functionality.\
3. Plan Execution: Implement the SourceCoordinate class and the extraction logic.\
SECTION 4: IMMEDIATE TASK SPECIFICATIONS Task: Implement Source Traceability. Requirements:\
1. Data Model: Update agents/enhanced_compliance/document_structure.py to include the SourceCoordinate dataclass as defined in the Architecture Spec. It must support page_index, x, y, width, and height (normalized 0-1).\
2. Parser Upgrade: Modify parser.py. Integrate a tool capable of extracting bounding boxes (likely pdfplumber). The system must return exact coordinates for every extracted "shall" statement to support a frontend overlay.\
3. Persistence: Ensure these coordinates are stored in the database  linked to the RequirementNode.\
Constraint: Do not delete the existing pypdf logic yet; we need a fallback. Implement this as an additive "Enhanced Traceability" mode.\
Question: based on AS_BUILT_TDD.md, where is the optimal insertion point for the bounding box extraction logic? Please generate your PEARL Plan now.}