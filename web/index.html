<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropelAI - RFP Intelligence Platform</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-card: #16161f;
            --border-color: #2a2a3a;
            --border-accent: #3a3a4a;
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --accent-blue: #4f8cff;
            --accent-blue-dim: #3a6acc;
            --accent-green: #34d399;
            --accent-amber: #fbbf24;
            --accent-red: #f87171;
            --accent-purple: #a78bfa;
            --gradient-blue: linear-gradient(135deg, #4f8cff 0%, #7c3aed 100%);
            --gradient-card: linear-gradient(180deg, rgba(79, 140, 255, 0.05) 0%, transparent 100%);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        
        .app-container { display: flex; min-height: 100vh; }
        
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }
        
        .logo { padding: 24px; border-bottom: 1px solid var(--border-color); }
        
        .logo h1 {
            font-size: 22px;
            font-weight: 700;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }
        
        .logo span {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            display: block;
            margin-top: 4px;
        }
        
        .nav-section { padding: 16px 12px; flex: 1; }
        
        .nav-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            padding: 8px 12px;
            margin-bottom: 4px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            margin-bottom: 2px;
        }
        
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: rgba(79, 140, 255, 0.15); color: var(--accent-blue); }
        .nav-item.disabled { opacity: 0.5; cursor: not-allowed; }
        .nav-item svg { width: 18px; height: 18px; opacity: 0.8; }
        
        .main-content { flex: 1; margin-left: 260px; padding: 32px 40px; background: var(--bg-primary); }
        
        .page-header { margin-bottom: 32px; }
        .page-header h2 { font-size: 28px; font-weight: 600; letter-spacing: -0.5px; margin-bottom: 8px; }
        .page-header p { color: var(--text-secondary); font-size: 15px; }
        
        .upload-zone {
            border: 2px dashed var(--border-accent);
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            background: var(--gradient-card);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .upload-zone:hover { border-color: var(--accent-blue); background: rgba(79, 140, 255, 0.05); }
        .upload-zone.dragging { border-color: var(--accent-blue); background: rgba(79, 140, 255, 0.1); transform: scale(1.01); }
        
        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upload-icon svg { width: 28px; height: 28px; color: var(--accent-blue); }
        .upload-zone h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .upload-zone p { color: var(--text-secondary); font-size: 14px; margin-bottom: 16px; }
        
        .file-types { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        
        .file-type {
            background: var(--bg-tertiary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: inherit;
        }
        
        .btn-primary { background: var(--gradient-blue); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(79, 140, 255, 0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-ghost { background: transparent; color: var(--text-secondary); padding: 8px; }
        .btn-ghost:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn svg { width: 18px; height: 18px; }
        
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 600; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; }
        .stat-card .label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .stat-card .value { font-size: 32px; font-weight: 700; letter-spacing: -1px; }
        .stat-card.blue .value { color: var(--accent-blue); }
        .stat-card.green .value { color: var(--accent-green); }
        .stat-card.amber .value { color: var(--accent-amber); }
        .stat-card.red .value { color: var(--accent-red); }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 14px 16px; border-bottom: 1px solid var(--border-color); }
        th { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600; background: var(--bg-tertiary); position: sticky; top: 0; }
        th:first-child { border-radius: 8px 0 0 0; }
        th:last-child { border-radius: 0 8px 0 0; }
        tr:hover td { background: rgba(79, 140, 255, 0.03); }
        td { font-size: 14px; }
        
        .req-id { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--accent-blue); }
        .req-text { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-blue { background: rgba(79, 140, 255, 0.15); color: var(--accent-blue); }
        .badge-green { background: rgba(52, 211, 153, 0.15); color: var(--accent-green); }
        .badge-amber { background: rgba(251, 191, 36, 0.15); color: var(--accent-amber); }
        .badge-red { background: rgba(248, 113, 113, 0.15); color: var(--accent-red); }
        .badge-purple { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }
        .badge-gray { background: var(--bg-tertiary); color: var(--text-secondary); }
        
        .priority-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .priority-high { background: var(--accent-red); }
        .priority-medium { background: var(--accent-amber); }
        .priority-low { background: var(--accent-green); }
        
        .progress-bar { height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--gradient-blue); border-radius: 3px; transition: width 0.5s ease; }
        
        .file-list { display: flex; flex-direction: column; gap: 8px; margin-top: 24px; }
        .file-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color); }
        .file-icon { width: 40px; height: 40px; background: var(--bg-secondary); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .file-icon svg { width: 20px; height: 20px; color: var(--accent-blue); }
        .file-info { flex: 1; }
        .file-name { font-weight: 500; font-size: 14px; }
        .file-meta { font-size: 12px; color: var(--text-muted); }
        .file-status { display: flex; align-items: center; gap: 8px; }
        
        .tabs { display: flex; gap: 4px; background: var(--bg-tertiary); padding: 4px; border-radius: 10px; margin-bottom: 24px; }
        .tab { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; border: none; background: transparent; font-family: inherit; }
        .tab:hover { color: var(--text-primary); }
        .tab.active { background: var(--bg-card); color: var(--text-primary); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        
        .processing-overlay { position: fixed; inset: 0; background: rgba(10, 10, 15, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(8px); }
        .processing-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 48px 64px; text-align: center; max-width: 480px; }
        .spinner { width: 48px; height: 48px; border: 3px solid var(--border-color); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 24px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .processing-card h3 { font-size: 20px; margin-bottom: 8px; }
        .processing-card p { color: var(--text-secondary); margin-bottom: 24px; }
        
        .actions-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .search-box { display: flex; align-items: center; gap: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 16px; width: 300px; }
        .search-box input { flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 14px; outline: none; font-family: inherit; }
        .search-box input::placeholder { color: var(--text-muted); }
        .search-box svg { width: 18px; height: 18px; color: var(--text-muted); }
        .filter-group { display: flex; gap: 8px; }
        
        select { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 16px; color: var(--text-primary); font-size: 14px; font-family: inherit; cursor: pointer; outline: none; }
        select:focus { border-color: var(--accent-blue); }
        
        .sidebar-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); }
        .sidebar-footer p { font-size: 12px; color: var(--text-muted); }
        
        .api-status { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 8px; }
        .api-dot { width: 8px; height: 8px; border-radius: 50%; }
        .api-dot.connected { background: var(--accent-green); }
        .api-dot.disconnected { background: var(--accent-red); }
        
        .error-banner { background: rgba(248, 113, 113, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; padding: 16px; margin-bottom: 24px; color: var(--accent-red); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease forwards; }
        
        /* Chat Typing Indicator */
        .typing-indicator { display: flex; gap: 4px; }
        .typing-indicator span { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { opacity: 0.3; transform: scale(1); } 30% { opacity: 1; transform: scale(1.2); } }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // API Configuration
        const API_BASE = window.location.origin + '/api';
        
        // API Client
        const api = {
            async health() {
                const res = await fetch(`${API_BASE}/health`);
                return res.json();
            },
            
            async createRFP(data) {
                const res = await fetch(`${API_BASE}/rfp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return res.json();
            },
            
            async uploadFiles(rfpId, files) {
                const formData = new FormData();
                files.forEach(f => formData.append('files', f));
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/upload`, {
                    method: 'POST',
                    body: formData
                });
                return res.json();
            },
            
            async processRFP(rfpId) {
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/process`, { method: 'POST' });
                return res.json();
            },
            
            async processRFPSemantic(rfpId) {
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/process-semantic`, { method: 'POST' });
                return res.json();
            },
            
            async processRFPBestPractices(rfpId) {
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/process-best-practices`, { method: 'POST' });
                return res.json();
            },
            
            async getStatus(rfpId) {
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/status`);
                return res.json();
            },
            
            async getRFP(rfpId) {
                const res = await fetch(`${API_BASE}/rfp/${rfpId}`);
                return res.json();
            },
            
            async getRequirements(rfpId, params = {}) {
                const query = new URLSearchParams(params).toString();
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/requirements?${query}`);
                return res.json();
            },
            
            async exportExcel(rfpId) {
                window.open(`${API_BASE}/rfp/${rfpId}/export?format=xlsx`, '_blank');
            },
            
            async getAmendments(rfpId) {
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/amendments`);
                return res.json();
            },
            
            async getOutline(rfpId) {
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/outline`);
                return res.json();
            },
            
            async exportOutline(rfpId) {
                window.open(`${API_BASE}/rfp/${rfpId}/outline/export`, '_blank');
            },
            
            async generateOutline(rfpId) {
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/outline`, { method: 'POST' });
                return res.json();
            },
            
            // Chat API (v2.12)
            async sendChatMessage(rfpId, message, includeSources = true) {
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, include_sources: includeSources })
                });
                if (!res.ok) {
                    throw new Error(`Chat failed: ${res.statusText}`);
                }
                return res.json();
            },
            
            async getChatHistory(rfpId, limit = 50) {
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/chat/history?limit=${limit}`);
                return res.json();
            },
            
            async clearChatHistory(rfpId) {
                const res = await fetch(`${API_BASE}/rfp/${rfpId}/chat/history`, {
                    method: 'DELETE'
                });
                return res.json();
            }
        };
        
        // Icon component
        function Icon({ name, size = 20 }) {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[name]) {
                    ref.current.innerHTML = '';
                    const icon = lucide.createElement(lucide.icons[name]);
                    ref.current.appendChild(icon);
                }
            }, [name]);
            return <span ref={ref} style={{ display: 'inline-flex', width: size, height: size }} />;
        }
        
        // Main App
        function App() {
            const [currentView, setCurrentView] = useState('upload');
            const [apiConnected, setApiConnected] = useState(false);
            const [error, setError] = useState(null);
            
            // RFP State
            const [currentRfpId, setCurrentRfpId] = useState(null);
            const [files, setFiles] = useState([]);
            const [rawFiles, setRawFiles] = useState([]);
            const [processing, setProcessing] = useState(false);
            const [processingStatus, setProcessingStatus] = useState({ status: '', progress: 0, message: '' });
            const [extractionMode, setExtractionMode] = useState('standard'); // v2.9: Default to best practices
            
            // Requirements State
            const [requirements, setRequirements] = useState([]);
            const [stats, setStats] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [filterType, setFilterType] = useState('all');
            const [filterPriority, setFilterPriority] = useState('all');
            
            // Chat State (v2.12)
            const [chatOpen, setChatOpen] = useState(false);
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [chatLoading, setChatLoading] = useState(false);
            
            // Check API health on mount
            useEffect(() => {
                const checkHealth = async () => {
                    try {
                        await api.health();
                        setApiConnected(true);
                    } catch (e) {
                        setApiConnected(false);
                    }
                };
                checkHealth();
                const interval = setInterval(checkHealth, 30000);
                return () => clearInterval(interval);
            }, []);
            
            // Poll for status while processing
            useEffect(() => {
                if (!processing || !currentRfpId) return;
                
                const pollStatus = async () => {
                    try {
                        const status = await api.getStatus(currentRfpId);
                        setProcessingStatus(status);
                        
                        if (status.status === 'completed') {
                            setProcessing(false);
                            await loadRequirements();
                            setCurrentView('matrix');
                        } else if (status.status === 'error') {
                            setProcessing(false);
                            setError(status.message);
                        }
                    } catch (e) {
                        console.error('Status poll error:', e);
                    }
                };
                
                const interval = setInterval(pollStatus, 1000);
                return () => clearInterval(interval);
            }, [processing, currentRfpId]);
            
            // Load requirements
            const loadRequirements = async () => {
                if (!currentRfpId) return;
                
                try {
                    const [rfpData, reqData] = await Promise.all([
                        api.getRFP(currentRfpId),
                        api.getRequirements(currentRfpId)
                    ]);
                    
                    setRequirements(reqData.requirements || []);
                    setStats(rfpData.stats);
                } catch (e) {
                    setError('Failed to load requirements: ' + e.message);
                }
            };
            
            // Process files
            const processFiles = async () => {
                if (rawFiles.length === 0) {
                    setError('Please upload files first');
                    return;
                }
                
                setError(null);
                setProcessing(true);
                setProcessingStatus({ status: 'starting', progress: 0, message: 'Creating RFP project...' });
                
                try {
                    // Create RFP
                    const rfp = await api.createRFP({
                        name: rawFiles[0]?.name?.replace(/\.[^/.]+$/, '') || 'New RFP',
                        solicitation_number: null,
                        agency: null
                    });
                    
                    setCurrentRfpId(rfp.id);
                    setProcessingStatus({ status: 'uploading', progress: 20, message: 'Uploading files...' });
                    
                    // Upload files
                    await api.uploadFiles(rfp.id, rawFiles);
                    setProcessingStatus({ status: 'processing', progress: 40, message: 'Starting processing...' });
                    
                    // Start processing
                    if (extractionMode === 'best_practices') {
                        await api.processRFPBestPractices(rfp.id);
                    } else if (extractionMode === 'semantic') {
                        await api.processRFPSemantic(rfp.id);
                    } else {
                        await api.processRFP(rfp.id);
                    }
                    
                    // Status polling will take over from here
                    
                } catch (e) {
                    setProcessing(false);
                    setError('Processing failed: ' + e.message);
                }
            };
            
            // Export to Excel
            const exportToExcel = () => {
                if (currentRfpId) {
                    api.exportExcel(currentRfpId);
                }
            };
            
            // Filter requirements
            const filteredRequirements = requirements.filter(req => {
                const matchesSearch = searchQuery === '' || 
                    req.text?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    req.id?.toLowerCase().includes(searchQuery.toLowerCase());
                const matchesType = filterType === 'all' || req.type === filterType;
                const matchesPriority = filterPriority === 'all' || req.priority === filterPriority;
                return matchesSearch && matchesType && matchesPriority;
            });
            
            // Chat Functions (v2.12)
            const loadChatHistory = async () => {
                if (!currentRfpId) return;
                try {
                    const data = await api.getChatHistory(currentRfpId);
                    setChatMessages(data.history || []);
                } catch (e) {
                    console.error('Failed to load chat history:', e);
                }
            };
            
            const sendChatMessage = async () => {
                if (!chatInput.trim() || !currentRfpId) return;
                
                const userMessage = chatInput.trim();
                setChatInput('');
                setChatLoading(true);
                
                // Add user message optimistically
                const userMsg = {
                    role: 'user',
                    content: userMessage,
                    timestamp: new Date().toISOString()
                };
                setChatMessages(prev => [...prev, userMsg]);
                
                try {
                    const response = await api.sendChatMessage(currentRfpId, userMessage, true);
                    
                    // Add assistant response
                    const assistantMsg = {
                        role: 'assistant',
                        content: response.answer,
                        sources: response.sources || [],
                        timestamp: response.timestamp
                    };
                    setChatMessages(prev => [...prev, assistantMsg]);
                    
                } catch (e) {
                    console.error('Chat error:', e);
                    
                    // Extract error message from response if available
                    let errorMessage = 'Sorry, I encountered an error. Please try again.';
                    if (e.message && e.message.includes('Error code:')) {
                        // Parse API error for better display
                        errorMessage = 'âš ï¸ Unable to generate response. This may be due to API access limitations. Please check your Anthropic API key configuration in Render.';
                    } else if (e.message) {
                        errorMessage = `âš ï¸ ${e.message}`;
                    }
                    
                    // Add error message to chat
                    const errorMsg = {
                        role: 'error',  // Special role for styling
                        content: errorMessage,
                        timestamp: new Date().toISOString()
                    };
                    setChatMessages(prev => [...prev, errorMsg]);
                } finally {
                    setChatLoading(false);
                }
            };
            
            const clearChat = async () => {
                if (!currentRfpId) return;
                try {
                    await api.clearChatHistory(currentRfpId);
                    setChatMessages([]);
                } catch (e) {
                    setError('Failed to clear chat: ' + e.message);
                }
            };
            
            // Load chat history when RFP changes
            useEffect(() => {
                if (currentRfpId && chatOpen) {
                    loadChatHistory();
                }
            }, [currentRfpId, chatOpen]);
            
            return (
                <div className="app-container">
                    {/* Sidebar */}
                    <aside className="sidebar">
                        <div className="logo">
                            <h1>PropelAI</h1>
                            <span>RFP Intelligence</span>
                        </div>
                        
                        <nav className="nav-section">
                            <div className="api-status">
                                <span className={`api-dot ${apiConnected ? 'connected' : 'disconnected'}`}></span>
                                <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>
                                    {apiConnected ? 'API Connected' : 'API Offline'}
                                </span>
                            </div>
                            
                            <div className="nav-label">Workspace</div>
                            <div 
                                className={`nav-item ${currentView === 'upload' ? 'active' : ''}`}
                                onClick={() => setCurrentView('upload')}
                            >
                                <Icon name="Upload" />
                                <span>Upload RFP</span>
                            </div>
                            <div 
                                className={`nav-item ${currentView === 'matrix' ? 'active' : ''} ${!stats ? 'disabled' : ''}`}
                                onClick={() => stats && setCurrentView('matrix')}
                            >
                                <Icon name="Table" />
                                <span>Compliance Matrix</span>
                            </div>
                            <div 
                                className={`nav-item ${currentView === 'amendments' ? 'active' : ''} ${!stats ? 'disabled' : ''}`}
                                onClick={() => stats && setCurrentView('amendments')}
                            >
                                <Icon name="GitBranch" />
                                <span>Amendments</span>
                            </div>
                            <div 
                                className={`nav-item ${currentView === 'outline' ? 'active' : ''} ${!stats ? 'disabled' : ''}`}
                                onClick={() => stats && setCurrentView('outline')}
                            >
                                <Icon name="FileText" />
                                <span>Proposal Outline</span>
                            </div>
                            
                            <div className="nav-label" style={{ marginTop: 24 }}>Company Library</div>
                            <div 
                                className={`nav-item ${currentView === 'library' ? 'active' : ''}`}
                                onClick={() => setCurrentView('library')}
                            >
                                <Icon name="Building" />
                                <span>Library</span>
                            </div>
                            
                            <div className="nav-label" style={{ marginTop: 24 }}>Coming Soon</div>
                            <div className="nav-item disabled">
                                <Icon name="Target" />
                                <span>Win Themes</span>
                            </div>
                        </nav>
                        
                        <div className="sidebar-footer">
                            <p>PropelAI v2.11</p>
                            {currentRfpId && <p style={{ marginTop: 4 }}>{currentRfpId}</p>}
                        </div>
                    </aside>
                    
                    {/* Main Content */}
                    <main className="main-content">
                        {error && (
                            <div className="error-banner">
                                <strong>Error:</strong> {error}
                                <button 
                                    onClick={() => setError(null)} 
                                    style={{ float: 'right', background: 'none', border: 'none', color: 'inherit', cursor: 'pointer' }}
                                >
                                    âœ•
                                </button>
                            </div>
                        )}
                        
                        {currentView === 'upload' && (
                            <UploadView 
                                files={files}
                                setFiles={setFiles}
                                rawFiles={rawFiles}
                                setRawFiles={setRawFiles}
                                onProcess={processFiles}
                                apiConnected={apiConnected}
                                extractionMode={extractionMode}
                                setExtractionMode={setExtractionMode}
                            />
                        )}
                        
                        {currentView === 'matrix' && stats && (
                            <MatrixView 
                                requirements={filteredRequirements}
                                allRequirements={requirements}
                                stats={stats}
                                searchQuery={searchQuery}
                                setSearchQuery={setSearchQuery}
                                filterType={filterType}
                                setFilterType={setFilterType}
                                filterPriority={filterPriority}
                                setFilterPriority={setFilterPriority}
                                onExport={exportToExcel}
                            />
                        )}
                        
                        {currentView === 'amendments' && stats && (
                            <AmendmentsView rfpId={currentRfpId} />
                        )}
                        
                        {currentView === 'outline' && stats && (
                            <OutlineView rfpId={currentRfpId} />
                        )}
                        
                        {currentView === 'library' && (
                            <LibraryView />
                        )}
                    </main>
                    
                    {/* Processing Overlay */}
                    {processing && (
                        <div className="processing-overlay">
                            <div className="processing-card animate-in">
                                <div className="spinner"></div>
                                <h3>Processing RFP</h3>
                                <p>{processingStatus.message}</p>
                                <div className="progress-bar">
                                    <div className="progress-fill" style={{ width: `${processingStatus.progress}%` }}></div>
                                </div>
                                <p style={{ marginTop: 16, fontSize: 12, color: 'var(--text-muted)' }}>
                                    {processingStatus.requirements_count ? `${processingStatus.requirements_count} requirements found` : ''}
                                </p>
                            </div>
                        </div>
                    )}
                    
                    {/* Chat with RFP (v2.12) */}
                    {currentRfpId && (
                        <>
                            {/* Chat Toggle Button */}
                            <button
                                className="chat-toggle-button"
                                onClick={() => setChatOpen(!chatOpen)}
                                title={chatOpen ? "Close chat" : "Open chat"}
                                style={{
                                    position: 'fixed',
                                    bottom: '24px',
                                    right: chatOpen ? '466px' : '24px',
                                    width: '56px',
                                    height: '56px',
                                    borderRadius: '50%',
                                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    border: 'none',
                                    boxShadow: '0 4px 12px rgba(102, 126, 234, 0.4)',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: 'white',
                                    transition: 'all 0.3s ease',
                                    zIndex: 999
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.transform = 'scale(1.1)';
                                    e.currentTarget.style.boxShadow = '0 6px 16px rgba(102, 126, 234, 0.5)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.transform = 'scale(1)';
                                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                                }}
                            >
                                <Icon name={chatOpen ? "X" : "MessageCircle"} size={24} />
                            </button>
                            
                            {/* Chat Drawer - Copilot Style */}
                            <div
                                className="chat-drawer"
                                style={{
                                    position: 'fixed',
                                    top: 0,
                                    right: chatOpen ? 0 : '-450px',
                                    width: '450px',
                                    height: '100vh',
                                    background: 'rgb(15, 23, 42)',
                                    borderLeft: '1px solid var(--border-color)',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    zIndex: 1000,
                                    transition: 'right 0.3s ease',
                                    boxShadow: chatOpen ? '-4px 0 24px rgba(0, 0, 0, 0.3)' : 'none'
                                }}
                            >
                                {chatOpen && (
                                <>
                                    {/* Header - Slimmer design */}
                                    <div style={{
                                        padding: '16px 20px',
                                        borderBottom: '1px solid var(--border-color)',
                                        background: 'rgba(102, 126, 234, 0.1)',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <div>
                                            <h3 style={{ margin: 0, fontSize: '15px', fontWeight: 600, color: 'white' }}>
                                                Chat with RFP
                                            </h3>
                                            <p style={{ margin: '2px 0 0', fontSize: '11px', color: 'rgba(255,255,255,0.6)' }}>
                                                Ask questions about this RFP
                                            </p>
                                        </div>
                                        <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                            <button
                                                onClick={clearChat}
                                                style={{
                                                    background: 'transparent',
                                                    border: '1px solid rgba(255,255,255,0.2)',
                                                    borderRadius: '6px',
                                                    padding: '4px 10px',
                                                    fontSize: '11px',
                                                    color: 'rgba(255,255,255,0.8)',
                                                    cursor: 'pointer'
                                                }}
                                                title="Clear chat history"
                                            >
                                                Clear
                                            </button>
                                            <button
                                                onClick={() => setChatOpen(false)}
                                                style={{
                                                    background: 'transparent',
                                                    border: 'none',
                                                    padding: '4px',
                                                    color: 'rgba(255,255,255,0.8)',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center'
                                                }}
                                                title="Close chat"
                                            >
                                                <Icon name="X" size={18} />
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Chat Messages */}
                                    <div style={{
                                        flex: 1,
                                        overflowY: 'auto',
                                        padding: '16px',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        gap: '16px'
                                    }}>
                                        {chatMessages.length === 0 ? (
                                            <div style={{
                                                display: 'flex',
                                                flexDirection: 'column',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                height: '100%',
                                                textAlign: 'center',
                                                color: 'var(--text-muted)',
                                                padding: '20px'
                                            }}>
                                                <Icon name="MessageCircle" size={48} />
                                                <p style={{ marginTop: '16px', fontSize: '14px' }}>
                                                    Ask me anything about this RFP!
                                                </p>
                                                <p style={{ marginTop: '8px', fontSize: '12px' }}>
                                                    Try: "What are the evaluation factors?" or "What's the page limit?"
                                                </p>
                                            </div>
                                        ) : (
                                            chatMessages.map((msg, idx) => (
                                                <div
                                                    key={idx}
                                                    style={{
                                                        display: 'flex',
                                                        flexDirection: msg.role === 'user' ? 'row-reverse' : 'row',
                                                        gap: '8px',
                                                        alignItems: 'flex-start'
                                                    }}
                                                >
                                                    <div style={{
                                                        width: '32px',
                                                        height: '32px',
                                                        borderRadius: '50%',
                                                        background: msg.role === 'user' 
                                                            ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                                                            : msg.role === 'error'
                                                            ? 'rgba(239, 68, 68, 0.2)'
                                                            : 'var(--border-color)',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        flexShrink: 0
                                                    }}>
                                                        <Icon name={msg.role === 'user' ? "User" : msg.role === 'error' ? "AlertCircle" : "Bot"} size={18} />
                                                    </div>
                                                    <div style={{
                                                        maxWidth: '75%',
                                                        background: msg.role === 'user' 
                                                            ? 'rgba(102, 126, 234, 0.2)'
                                                            : msg.role === 'error'
                                                            ? 'rgba(239, 68, 68, 0.15)'
                                                            : 'rgba(255,255,255,0.05)',
                                                        padding: '12px 16px',
                                                        borderRadius: '12px',
                                                        fontSize: '14px',
                                                        lineHeight: '1.5',
                                                        border: msg.role === 'error' ? '1px solid rgba(239, 68, 68, 0.3)' : 'none'
                                                    }}>
                                                        <div style={{ 
                                                            color: msg.role === 'error' ? 'rgba(239, 68, 68, 0.9)' : 'inherit',
                                                            whiteSpace: 'pre-wrap'
                                                        }}>{msg.content}</div>
                                                        {msg.sources && msg.sources.length > 0 && (
                                                            <details style={{ marginTop: '12px', fontSize: '12px' }}>
                                                                <summary style={{ cursor: 'pointer', color: 'var(--text-muted)' }}>
                                                                    ðŸ“Ž {msg.sources.length} source{msg.sources.length > 1 ? 's' : ''}
                                                                </summary>
                                                                <div style={{ marginTop: '8px', paddingLeft: '8px' }}>
                                                                    {msg.sources.map((src, i) => (
                                                                        <div key={i} style={{
                                                                            marginTop: '8px',
                                                                            padding: '8px',
                                                                            background: 'rgba(255,255,255,0.03)',
                                                                            borderRadius: '6px',
                                                                            borderLeft: '2px solid rgba(102, 126, 234, 0.5)'
                                                                        }}>
                                                                            <div style={{ fontWeight: 600, marginBottom: '4px' }}>
                                                                                Section {src.section}, Page {src.page}
                                                                            </div>
                                                                            <div style={{ color: 'var(--text-muted)', fontSize: '11px' }}>
                                                                                {src.text}
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </details>
                                                        )}
                                                        <div style={{ 
                                                            marginTop: '8px', 
                                                            fontSize: '11px', 
                                                            color: 'var(--text-muted)' 
                                                        }}>
                                                            {new Date(msg.timestamp).toLocaleTimeString()}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                        
                                        {chatLoading && (
                                            <div style={{
                                                display: 'flex',
                                                gap: '8px',
                                                alignItems: 'flex-start'
                                            }}>
                                                <div style={{
                                                    width: '32px',
                                                    height: '32px',
                                                    borderRadius: '50%',
                                                    background: 'var(--border-color)',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center'
                                                }}>
                                                    <Icon name="Bot" size={18} />
                                                </div>
                                                <div style={{
                                                    background: 'rgba(255,255,255,0.05)',
                                                    padding: '12px 16px',
                                                    borderRadius: '12px',
                                                    fontSize: '14px'
                                                }}>
                                                    <div className="typing-indicator">
                                                        <span></span><span></span><span></span>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Chat Input */}
                                    <div style={{
                                        padding: '16px',
                                        borderTop: '1px solid var(--border-color)',
                                        background: 'var(--bg-primary)'
                                    }}>
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <input
                                                type="text"
                                                value={chatInput}
                                                onChange={(e) => setChatInput(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && sendChatMessage()}
                                                placeholder="Ask about this RFP..."
                                                disabled={chatLoading}
                                                style={{
                                                    flex: 1,
                                                    padding: '12px 16px',
                                                    border: '1px solid var(--border-color)',
                                                    borderRadius: '8px',
                                                    background: 'var(--card-bg)',
                                                    color: 'var(--text-primary)',
                                                    fontSize: '14px',
                                                    outline: 'none'
                                                }}
                                            />
                                            <button
                                                onClick={sendChatMessage}
                                                disabled={chatLoading || !chatInput.trim()}
                                                style={{
                                                    padding: '12px 20px',
                                                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                    border: 'none',
                                                    borderRadius: '8px',
                                                    color: 'white',
                                                    cursor: chatLoading || !chatInput.trim() ? 'not-allowed' : 'pointer',
                                                    opacity: chatLoading || !chatInput.trim() ? 0.5 : 1,
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center'
                                                }}
                                            >
                                                <Icon name="Send" size={18} />
                                            </button>
                                        </div>
                                    </div>
                                </>
                                )}
                            </div>
                        </>
                    )}
                </div>
            );
        }
        
        // Upload View
        function UploadView({ files, setFiles, rawFiles, setRawFiles, onProcess, apiConnected, extractionMode, setExtractionMode }) {
            const [dragging, setDragging] = useState(false);
            const fileInputRef = useRef(null);
            
            const handleDrop = (e) => {
                e.preventDefault();
                setDragging(false);
                const droppedFiles = Array.from(e.dataTransfer.files);
                addFiles(droppedFiles);
            };
            
            const handleFileSelect = (e) => {
                const selectedFiles = Array.from(e.target.files);
                addFiles(selectedFiles);
            };
            
            const addFiles = (newFiles) => {
                const validFiles = newFiles.filter(f => {
                    const ext = f.name.split('.').pop().toLowerCase();
                    return ['pdf', 'docx', 'xlsx', 'doc', 'xls'].includes(ext);
                });
                
                const fileData = validFiles.map(f => ({
                    name: f.name,
                    size: formatFileSize(f.size),
                    type: f.name.split('.').pop().toUpperCase(),
                    status: 'ready'
                }));
                
                setFiles([...files, ...fileData]);
                setRawFiles([...rawFiles, ...validFiles]);
            };
            
            const removeFile = (index) => {
                setFiles(files.filter((_, i) => i !== index));
                setRawFiles(rawFiles.filter((_, i) => i !== index));
            };
            
            const clearAll = () => {
                setFiles([]);
                setRawFiles([]);
            };
            
            return (
                <div className="animate-in">
                    <div className="page-header">
                        <h2>Upload RFP Documents</h2>
                        <p>Upload your RFP package to extract requirements and build a compliance matrix</p>
                    </div>
                    
                    <div 
                        className={`upload-zone ${dragging ? 'dragging' : ''}`}
                        onDragOver={(e) => { e.preventDefault(); setDragging(true); }}
                        onDragLeave={() => setDragging(false)}
                        onDrop={handleDrop}
                        onClick={() => fileInputRef.current?.click()}
                    >
                        <input
                            ref={fileInputRef}
                            type="file"
                            multiple
                            accept=".pdf,.docx,.xlsx,.doc,.xls"
                            onChange={handleFileSelect}
                            style={{ display: 'none' }}
                        />
                        <div className="upload-icon">
                            <Icon name="Upload" size={28} />
                        </div>
                        <h3>Drop files here or click to browse</h3>
                        <p>Upload RFP documents, amendments, attachments, and Q&A files</p>
                        <div className="file-types">
                            <span className="file-type">.pdf</span>
                            <span className="file-type">.docx</span>
                            <span className="file-type">.xlsx</span>
                        </div>
                    </div>
                    
                    {files.length > 0 && (
                        <div className="file-list">
                            {files.map((file, index) => (
                                <div key={index} className="file-item">
                                    <div className="file-icon">
                                        <Icon name="FileText" />
                                    </div>
                                    <div className="file-info">
                                        <div className="file-name">{file.name}</div>
                                        <div className="file-meta">{file.type} Â· {file.size}</div>
                                    </div>
                                    <div className="file-status">
                                        <span className="badge badge-green">Ready</span>
                                        <button 
                                            className="btn btn-ghost"
                                            onClick={(e) => { e.stopPropagation(); removeFile(index); }}
                                        >
                                            <Icon name="X" size={16} />
                                        </button>
                                    </div>
                                </div>
                            ))}
                            
                            <div style={{ marginTop: 24, display: 'flex', gap: 12, alignItems: 'center', flexWrap: 'wrap' }}>
                                <button 
                                    className="btn btn-primary" 
                                    onClick={onProcess}
                                    disabled={!apiConnected}
                                >
                                    <Icon name="Zap" />
                                    {apiConnected ? 'Process RFP' : 'API Offline'}
                                </button>
                                <button className="btn btn-secondary" onClick={clearAll}>
                                    Clear All
                                </button>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginLeft: 16 }}>
                                    <span style={{ color: 'var(--text-secondary)', fontSize: 13 }}>
                                        Extraction Mode:
                                    </span>
                                    <select 
                                        value={extractionMode}
                                        onChange={(e) => setExtractionMode(e.target.value)}
                                        style={{ 
                                            background: 'var(--bg-secondary)', 
                                            border: '1px solid var(--border-color)',
                                            borderRadius: 6,
                                            padding: '6px 12px',
                                            color: 'var(--text-primary)',
                                            fontSize: 13,
                                            cursor: 'pointer'
                                        }}
                                    >
                                        <option value="best_practices">v2.9 Best Practices CTM</option>
                                        <option value="semantic">v2.8 Semantic</option>
                                        <option value="legacy">Legacy</option>
                                    </select>
                                    {extractionMode === 'best_practices' && (
                                        <span 
                                            style={{ 
                                                fontSize: 10, 
                                                background: 'var(--accent-green)', 
                                                color: 'black', 
                                                padding: '2px 6px', 
                                                borderRadius: 4,
                                                fontWeight: 600
                                            }}
                                        >
                                            NEW
                                        </span>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // Matrix View
        function MatrixView({ 
            requirements, allRequirements, stats, 
            searchQuery, setSearchQuery, 
            filterType, setFilterType,
            filterPriority, setFilterPriority,
            onExport
        }) {
            const uniqueTypes = [...new Set(allRequirements.map(r => r.type).filter(Boolean))];
            
            return (
                <div className="animate-in">
                    <div className="page-header">
                        <h2>Compliance Matrix</h2>
                        <p>Extracted {stats?.total || allRequirements.length} requirements from your RFP documents</p>
                    </div>
                    
                    {/* RFP Format Note (for GSA/BPA) */}
                    {stats?.is_non_ucf_format && (
                        <div style={{
                            background: 'rgba(251, 146, 60, 0.1)',
                            border: '1px solid rgba(251, 146, 60, 0.3)',
                            borderRadius: '8px',
                            padding: '12px 16px',
                            marginBottom: '20px',
                            display: 'flex',
                            alignItems: 'flex-start',
                            gap: '12px'
                        }}>
                            <span style={{ color: '#fb923c', fontSize: '18px' }}>â„¹ï¸</span>
                            <div>
                                <div style={{ fontWeight: '600', color: '#fb923c', marginBottom: '4px' }}>
                                    GSA Schedule / BPA Format Detected
                                </div>
                                <div style={{ fontSize: '13px', color: 'rgba(255,255,255,0.7)' }}>
                                    This RFP does not follow the standard UCF format (Sections L/M/C). 
                                    Submission instructions are in <strong>Section M Alignment</strong> ({stats?.evaluation || 0} items). 
                                    Technical requirements are in the <strong>PWS/SOW</strong> ({stats?.technical || 0} items).
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Stats */}
                    <div className="stats-grid">
                        <div className="stat-card blue">
                            <div className="label">Total Requirements</div>
                            <div className="value">{stats?.total || allRequirements.length}</div>
                        </div>
                        <div className="stat-card red">
                            <div className="label">High Priority</div>
                            <div className="value">{stats?.by_priority?.high || 0}</div>
                        </div>
                        <div className="stat-card amber">
                            <div className="label">Medium Priority</div>
                            <div className="value">{stats?.by_priority?.medium || 0}</div>
                        </div>
                        <div className="stat-card green">
                            <div className="label">Low Priority</div>
                            <div className="value">{stats?.by_priority?.low || 0}</div>
                        </div>
                    </div>
                    
                    {/* Actions */}
                    <div className="actions-bar">
                        <div className="search-box">
                            <Icon name="Search" />
                            <input 
                                type="text"
                                placeholder="Search requirements..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                        </div>
                        <div className="filter-group">
                            <select value={filterType} onChange={(e) => setFilterType(e.target.value)}>
                                <option value="all">All Types</option>
                                {uniqueTypes.map(type => (
                                    <option key={type} value={type}>{type}</option>
                                ))}
                            </select>
                            <select value={filterPriority} onChange={(e) => setFilterPriority(e.target.value)}>
                                <option value="all">All Priorities</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                            <button className="btn btn-primary" onClick={onExport}>
                                <Icon name="Download" />
                                Export Excel
                            </button>
                        </div>
                    </div>
                    
                    {/* Table */}
                    <div className="card">
                        <div className="table-container" style={{ maxHeight: '500px', overflow: 'auto' }}>
                            <table>
                                <thead>
                                    <tr>
                                        <th style={{ width: 100 }}>ID</th>
                                        <th>Requirement</th>
                                        <th style={{ width: 100 }}>Section</th>
                                        <th style={{ width: 120 }}>Type</th>
                                        <th style={{ width: 100 }}>Priority</th>
                                        <th style={{ width: 80 }}>Confidence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {requirements.map((req, idx) => (
                                        <tr key={req.id || idx}>
                                            <td><span className="req-id">{req.id}</span></td>
                                            <td className="req-text" title={req.text}>{req.text}</td>
                                            <td>{req.section}</td>
                                            <td><span className={`badge badge-${getTypeBadgeColor(req.type)}`}>{req.type}</span></td>
                                            <td>
                                                <span className={`priority-dot priority-${req.priority}`}></span>
                                                {req.priority}
                                            </td>
                                            <td>{Math.round((req.confidence || 0) * 100)}%</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style={{ marginTop: 16, color: 'var(--text-muted)', fontSize: 14 }}>
                        Showing {requirements.length} of {allRequirements.length} requirements
                        {stats?.processing_time && ` Â· Processed in ${stats.processing_time.toFixed(2)}s`}
                    </div>
                </div>
            );
        }
        
        // Amendments View
        function AmendmentsView({ rfpId }) {
            const [amendments, setAmendments] = useState([]);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                if (rfpId) {
                    api.getAmendments(rfpId).then(data => {
                        setAmendments(data.amendments || []);
                        setLoading(false);
                    }).catch(() => setLoading(false));
                }
            }, [rfpId]);
            
            return (
                <div className="animate-in">
                    <div className="page-header">
                        <h2>Amendment Tracking</h2>
                        <p>Track changes across RFP versions and amendments</p>
                    </div>
                    
                    {loading ? (
                        <div style={{ textAlign: 'center', padding: 60, color: 'var(--text-muted)' }}>
                            Loading amendments...
                        </div>
                    ) : amendments.length === 0 ? (
                        <div className="card" style={{ textAlign: 'center', padding: 60 }}>
                            <Icon name="GitBranch" size={48} />
                            <h3 style={{ marginTop: 16, marginBottom: 8 }}>No Amendments Yet</h3>
                            <p style={{ color: 'var(--text-muted)' }}>
                                Upload amendment documents to track changes
                            </p>
                        </div>
                    ) : (
                        <div className="card">
                            <div className="card-header">
                                <h3 className="card-title">Amendment History</h3>
                            </div>
                            {amendments.map((a, idx) => (
                                <div key={idx} style={{ 
                                    padding: 16, 
                                    borderBottom: '1px solid var(--border-color)',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: 16
                                }}>
                                    <div style={{ 
                                        width: 40, height: 40, 
                                        background: 'var(--bg-tertiary)', 
                                        borderRadius: 8,
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontWeight: 600
                                    }}>
                                        {a.number}
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ fontWeight: 500 }}>Amendment {a.number}</div>
                                        <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>{a.date} Â· {a.file}</div>
                                    </div>
                                    <div style={{ display: 'flex', gap: 8 }}>
                                        <span className="badge badge-green">+{a.changes?.added || 0}</span>
                                        <span className="badge badge-amber">{a.changes?.modified || 0}</span>
                                        <span className="badge badge-red">-{a.changes?.deleted || 0}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }
        
        // Outline View
        function OutlineView({ rfpId }) {
            const [outline, setOutline] = useState(null);
            const [loading, setLoading] = useState(true);
            const [generating, setGenerating] = useState(false);
            const [activeVolume, setActiveVolume] = useState(null);
            
            useEffect(() => {
                if (rfpId) {
                    loadOutline();
                }
            }, [rfpId]);
            
            const loadOutline = async () => {
                setLoading(true);
                try {
                    const data = await api.getOutline(rfpId);
                    setOutline(data.outline);
                    if (data.outline?.volumes?.length > 0) {
                        setActiveVolume(data.outline.volumes[0].id);
                    }
                } catch (e) {
                    // Outline not generated yet
                    setOutline(null);
                } finally {
                    setLoading(false);
                }
            };
            
            const generateOutline = async () => {
                setGenerating(true);
                try {
                    const data = await api.generateOutline(rfpId);
                    setOutline(data.outline);
                    if (data.outline?.volumes?.length > 0) {
                        setActiveVolume(data.outline.volumes[0].id);
                    }
                } catch (e) {
                    console.error('Failed to generate outline:', e);
                } finally {
                    setGenerating(false);
                }
            };
            
            const getVolumeIcon = (type) => {
                const icons = {
                    technical: 'Cpu',
                    management: 'Users',
                    past_performance: 'Award',
                    cost_price: 'DollarSign',
                    staffing: 'UserCheck',
                    small_business: 'Building',
                    oral_presentation: 'Presentation',
                    other: 'FileText'
                };
                return icons[type] || 'FileText';
            };
            
            if (loading) {
                return (
                    <div className="animate-in" style={{ textAlign: 'center', padding: 60 }}>
                        <div className="spinner"></div>
                        <p style={{ marginTop: 16, color: 'var(--text-muted)' }}>Loading outline...</p>
                    </div>
                );
            }
            
            if (!outline) {
                return (
                    <div className="animate-in">
                        <div className="page-header">
                            <h2>Proposal Outline</h2>
                            <p>Generate a proposal outline from Section L/M</p>
                        </div>
                        
                        <div className="card" style={{ textAlign: 'center', padding: 60 }}>
                            <Icon name="FileText" size={48} />
                            <h3 style={{ marginTop: 16, marginBottom: 8 }}>Generate Proposal Outline</h3>
                            <p style={{ color: 'var(--text-muted)', marginBottom: 24 }}>
                                Parse Section L (Instructions) and Section M (Evaluation Factors) to create a proposal-ready outline
                            </p>
                            <button 
                                className="btn btn-primary" 
                                onClick={generateOutline}
                                disabled={generating}
                            >
                                {generating ? (
                                    <>
                                        <span className="spinner" style={{ width: 18, height: 18, borderWidth: 2 }}></span>
                                        Generating...
                                    </>
                                ) : (
                                    <>
                                        <Icon name="Zap" />
                                        Generate Outline
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                );
            }
            
            const activeVolumeData = outline.volumes?.find(v => v.id === activeVolume);
            
            return (
                <div className="animate-in">
                    <div className="page-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                        <div>
                            <h2>Proposal Outline</h2>
                            <p>Structure your proposal based on RFP requirements</p>
                        </div>
                        <button 
                            className="btn btn-primary"
                            onClick={() => api.exportOutline(rfpId)}
                            title="Download annotated outline as Word document"
                        >
                            <Icon name="Download" />
                            Export Outline
                        </button>
                    </div>
                    
                    {/* Submission & Format Info */}
                    <div className="stats-grid" style={{ marginBottom: 24 }}>
                        <div className="stat-card">
                            <div className="label">Due Date</div>
                            <div className="value" style={{ fontSize: 18 }}>
                                {outline.submission?.due_date || 'TBD'}
                            </div>
                        </div>
                        <div className="stat-card">
                            <div className="label">Submission</div>
                            <div className="value" style={{ fontSize: 18, textTransform: 'capitalize' }}>
                                {outline.submission?.method || 'Not specified'}
                            </div>
                        </div>
                        <div className="stat-card">
                            <div className="label">Total Pages</div>
                            <div className="value" style={{ fontSize: 18 }}>
                                {outline.total_page_limit || 'No limit'}
                            </div>
                        </div>
                        <div className="stat-card">
                            <div className="label">Volumes</div>
                            <div className="value" style={{ fontSize: 18 }}>
                                {outline.volumes?.length || 0}
                            </div>
                        </div>
                    </div>
                    
                    <div style={{ display: 'grid', gridTemplateColumns: '300px 1fr', gap: 24 }}>
                        {/* Volumes Sidebar */}
                        <div className="card" style={{ padding: 0 }}>
                            <div style={{ padding: 16, borderBottom: '1px solid var(--border-color)' }}>
                                <h3 style={{ fontSize: 14, fontWeight: 600 }}>Proposal Volumes</h3>
                            </div>
                            {outline.volumes?.map((vol) => (
                                <div 
                                    key={vol.id}
                                    onClick={() => setActiveVolume(vol.id)}
                                    style={{ 
                                        padding: 16, 
                                        borderBottom: '1px solid var(--border-color)',
                                        cursor: 'pointer',
                                        background: activeVolume === vol.id ? 'rgba(79, 140, 255, 0.1)' : 'transparent',
                                        borderLeft: activeVolume === vol.id ? '3px solid var(--accent-blue)' : '3px solid transparent'
                                    }}
                                >
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                        <Icon name={getVolumeIcon(vol.type)} size={18} />
                                        <div>
                                            <div style={{ fontWeight: 500, fontSize: 14 }}>{vol.name}</div>
                                            <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>
                                                {vol.page_limit ? `${vol.page_limit} pages` : 'No page limit'}
                                                {vol.sections?.length > 0 && ` Â· ${vol.sections.length} sections`}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        {/* Volume Detail */}
                        <div>
                            {/* Evaluation Factors */}
                            <div className="card" style={{ marginBottom: 24 }}>
                                <div className="card-header">
                                    <h3 className="card-title">Evaluation Factors</h3>
                                </div>
                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: 12 }}>
                                    {outline.evaluation_factors?.map((factor, idx) => (
                                        <div key={idx} style={{ 
                                            padding: '12px 16px', 
                                            background: 'var(--bg-tertiary)', 
                                            borderRadius: 8,
                                            flex: '1 1 200px'
                                        }}>
                                            <div style={{ fontWeight: 500, marginBottom: 4 }}>{factor.name}</div>
                                            {factor.weight && (
                                                <span className="badge badge-blue">
                                                    {factor.weight} {factor.weight_type || 'pts'}
                                                </span>
                                            )}
                                            {factor.importance && (
                                                <span className="badge badge-purple" style={{ marginLeft: 8 }}>
                                                    {factor.importance}
                                                </span>
                                            )}
                                            {factor.subfactors?.length > 0 && (
                                                <div style={{ marginTop: 8, fontSize: 12, color: 'var(--text-secondary)' }}>
                                                    {factor.subfactors.map((sf, i) => (
                                                        <div key={i}>â€¢ {sf.name}</div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Active Volume Sections */}
                            {activeVolumeData && (
                                <div className="card">
                                    <div className="card-header">
                                        <h3 className="card-title">{activeVolumeData.name} - Sections</h3>
                                        {activeVolumeData.page_limit && (
                                            <span className="badge badge-blue">{activeVolumeData.page_limit} pages</span>
                                        )}
                                    </div>
                                    
                                    {activeVolumeData.sections?.length > 0 ? (
                                        activeVolumeData.sections.map((section, idx) => (
                                            <div key={idx} style={{ 
                                                padding: 16, 
                                                borderBottom: '1px solid var(--border-color)'
                                            }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                    <div>
                                                        <div style={{ fontWeight: 500, marginBottom: 8 }}>{section.title}</div>
                                                        
                                                        {section.content_requirements?.length > 0 && (
                                                            <div style={{ marginBottom: 8 }}>
                                                                <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>CONTENT REQUIREMENTS</div>
                                                                {section.content_requirements.slice(0, 2).map((req, i) => (
                                                                    <div key={i} style={{ fontSize: 13, color: 'var(--text-secondary)', marginBottom: 2 }}>
                                                                        â€¢ {req.slice(0, 150)}{req.length > 150 ? '...' : ''}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                        
                                                        {section.compliance_checkpoints?.length > 0 && (
                                                            <div>
                                                                <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>CHECKLIST</div>
                                                                {section.compliance_checkpoints.slice(0, 3).map((cp, i) => (
                                                                    <div key={i} style={{ fontSize: 13, color: 'var(--text-secondary)' }}>
                                                                        {cp}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                    {section.page_limit && (
                                                        <span className="badge badge-gray">{section.page_limit}p</span>
                                                    )}
                                                </div>
                                            </div>
                                        ))
                                    ) : (
                                        <div style={{ padding: 24, textAlign: 'center', color: 'var(--text-muted)' }}>
                                            No detailed sections found for this volume
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Warnings */}
                            {outline.warnings?.length > 0 && (
                                <div className="card" style={{ marginTop: 24, background: 'rgba(251, 191, 36, 0.1)', borderColor: 'var(--accent-amber)' }}>
                                    <div className="card-header">
                                        <h3 className="card-title" style={{ color: 'var(--accent-amber)' }}>âš ï¸ Warnings</h3>
                                    </div>
                                    {outline.warnings.map((warning, idx) => (
                                        <div key={idx} style={{ padding: '8px 16px', fontSize: 14 }}>
                                            {warning}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        
        // Company Library View
        function LibraryView() {
            const [library, setLibrary] = useState(null);
            const [loading, setLoading] = useState(true);
            const [uploading, setUploading] = useState(false);
            const [activeTab, setActiveTab] = useState('overview');
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const fileInputRef = useRef(null);
            
            useEffect(() => {
                loadLibrary();
            }, []);
            
            const loadLibrary = async () => {
                try {
                    const response = await fetch('/api/library');
                    const data = await response.json();
                    setLibrary(data);
                } catch (error) {
                    console.error('Error loading library:', error);
                } finally {
                    setLoading(false);
                }
            };
            
            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setUploading(true);
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/api/library/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        loadLibrary();
                    }
                } catch (error) {
                    console.error('Error uploading:', error);
                } finally {
                    setUploading(false);
                    fileInputRef.current.value = '';
                }
            };
            
            const handleSearch = async () => {
                if (!searchQuery.trim()) return;
                
                try {
                    const response = await fetch(`/api/library/search?query=${encodeURIComponent(searchQuery)}`);
                    const data = await response.json();
                    setSearchResults(data.results || []);
                } catch (error) {
                    console.error('Error searching:', error);
                }
            };
            
            const deleteDocument = async (docId) => {
                if (!confirm('Remove this document from library?')) return;
                
                try {
                    await fetch(`/api/library/documents/${docId}`, { method: 'DELETE' });
                    loadLibrary();
                } catch (error) {
                    console.error('Error deleting:', error);
                }
            };
            
            if (loading) {
                return (
                    <div style={{ padding: 40, textAlign: 'center' }}>
                        <div className="spinner"></div>
                        <p style={{ marginTop: 16 }}>Loading library...</p>
                    </div>
                );
            }
            
            return (
                <div>
                    <div className="view-header">
                        <div>
                            <h1>Company Library</h1>
                            <p className="text-muted">Upload capabilities statements, past performance, and resumes for enhanced proposal generation</p>
                        </div>
                        <div>
                            <input
                                type="file"
                                ref={fileInputRef}
                                onChange={handleFileUpload}
                                accept=".docx,.doc,.pdf,.txt,.md"
                                style={{ display: 'none' }}
                            />
                            <button 
                                className="btn btn-primary"
                                onClick={() => fileInputRef.current.click()}
                                disabled={uploading}
                            >
                                {uploading ? 'Uploading...' : '+ Upload Document'}
                            </button>
                        </div>
                    </div>
                    
                    {/* Stats Cards */}
                    <div className="stats-grid" style={{ marginBottom: 24 }}>
                        <div className="stat-card">
                            <div className="stat-label">Documents</div>
                            <div className="stat-value">{library?.document_count || 0}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Capabilities</div>
                            <div className="stat-value">{library?.profile_summary?.capabilities_count || 0}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Differentiators</div>
                            <div className="stat-value">{library?.profile_summary?.differentiators_count || 0}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Past Performance</div>
                            <div className="stat-value">{library?.profile_summary?.past_performance_count || 0}</div>
                        </div>
                    </div>
                    
                    {/* Tabs */}
                    <div style={{ display: 'flex', gap: 8, marginBottom: 16, borderBottom: '1px solid var(--border-color)', paddingBottom: 8 }}>
                        {['overview', 'documents', 'search'].map(tab => (
                            <button
                                key={tab}
                                className={`btn ${activeTab === tab ? 'btn-primary' : ''}`}
                                onClick={() => setActiveTab(tab)}
                                style={{ textTransform: 'capitalize' }}
                            >
                                {tab}
                            </button>
                        ))}
                    </div>
                    
                    {activeTab === 'overview' && (
                        <div className="card">
                            <div className="card-header">
                                <h3 className="card-title">
                                    {library?.profile_summary?.company_name || 'Company Profile'}
                                </h3>
                            </div>
                            
                            {library?.document_count === 0 ? (
                                <div style={{ padding: 40, textAlign: 'center', color: 'var(--text-muted)' }}>
                                    <Icon name="Building" style={{ width: 48, height: 48, marginBottom: 16, opacity: 0.5 }} />
                                    <p>No documents in library yet</p>
                                    <p style={{ fontSize: 13, marginTop: 8 }}>Upload a capabilities statement to get started</p>
                                </div>
                            ) : (
                                <div style={{ padding: 16 }}>
                                    <p style={{ marginBottom: 16 }}>
                                        Your library contains <strong>{library?.profile_summary?.capabilities_count || 0}</strong> capabilities, 
                                        <strong> {library?.profile_summary?.differentiators_count || 0}</strong> differentiators, and 
                                        <strong> {library?.profile_summary?.past_performance_count || 0}</strong> past performance records.
                                    </p>
                                    <p style={{ color: 'var(--text-muted)', fontSize: 13 }}>
                                        This content will be used to enhance your proposal drafts with relevant company information.
                                    </p>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {activeTab === 'documents' && (
                        <div className="card">
                            <div className="card-header">
                                <h3 className="card-title">Uploaded Documents</h3>
                            </div>
                            
                            {library?.documents?.length === 0 ? (
                                <div style={{ padding: 40, textAlign: 'center', color: 'var(--text-muted)' }}>
                                    No documents uploaded yet
                                </div>
                            ) : (
                                library?.documents?.map(doc => (
                                    <div key={doc.id} style={{ 
                                        padding: 16, 
                                        borderBottom: '1px solid var(--border-color)',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <div>
                                            <div style={{ fontWeight: 500 }}>{doc.title}</div>
                                            <div style={{ fontSize: 13, color: 'var(--text-muted)', marginTop: 4 }}>
                                                <span className={`badge badge-${doc.type === 'capabilities' ? 'blue' : doc.type === 'resume' ? 'green' : 'purple'}`}>
                                                    {doc.type}
                                                </span>
                                                <span style={{ marginLeft: 8 }}>{doc.filename}</span>
                                            </div>
                                        </div>
                                        <button 
                                            className="btn"
                                            onClick={() => deleteDocument(doc.id)}
                                            style={{ color: 'var(--accent-red)' }}
                                        >
                                            Remove
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                    
                    {activeTab === 'search' && (
                        <div className="card">
                            <div className="card-header">
                                <h3 className="card-title">Search Library</h3>
                            </div>
                            <div style={{ padding: 16 }}>
                                <div style={{ display: 'flex', gap: 8, marginBottom: 16 }}>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="Search capabilities, differentiators, past performance..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                                        style={{ flex: 1 }}
                                    />
                                    <button className="btn btn-primary" onClick={handleSearch}>
                                        Search
                                    </button>
                                </div>
                                
                                {searchResults.length > 0 && (
                                    <div>
                                        <div style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 12 }}>
                                            Found {searchResults.length} results
                                        </div>
                                        {searchResults.map((result, idx) => (
                                            <div key={idx} style={{ 
                                                padding: 12, 
                                                background: 'var(--bg-tertiary)', 
                                                borderRadius: 8,
                                                marginBottom: 8
                                            }}>
                                                <div style={{ display: 'flex', gap: 8, alignItems: 'center', marginBottom: 4 }}>
                                                    <span className={`badge badge-${result.type === 'capability' ? 'blue' : result.type === 'differentiator' ? 'purple' : 'green'}`}>
                                                        {result.type}
                                                    </span>
                                                    <span style={{ fontWeight: 500 }}>
                                                        {result.content.name || result.content.title || result.content.project_name}
                                                    </span>
                                                </div>
                                                <div style={{ fontSize: 13, color: 'var(--text-secondary)' }}>
                                                    {result.content.description?.slice(0, 200) || ''}
                                                    {result.content.description?.length > 200 ? '...' : ''}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // Helpers
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function getTypeBadgeColor(type) {
            const colors = {
                performance: 'blue',
                compliance: 'purple',
                technical: 'green',
                deliverable: 'amber',
                prohibition: 'red',
                evaluation: 'purple',
                proposal_instruction: 'gray',
                labor_requirement: 'amber'
            };
            return colors[type] || 'gray';
        }
        
        // Render
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
